@page "/mainframeView"
@using Mainframe
@using Blazor.Extensions
@using Blazor.Extensions.Canvas.Canvas2D
@using Blazor.Extensions.Canvas.WebGL
@using System.Drawing
@using System.Drawing.Imaging
@using System.Drawing.Drawing2D
@rendermode InteractiveServer

@inject IJSRuntime JsRuntime

<PageTitle>MainframeVew</PageTitle>

<h1>Mainframe View</h1>

<BECanvas Width="800" Height="600" @ref="canvasRef"></BECanvas>

<img @ref="imgsheet" id="imgsheet" src="@imageDataURL" />

@code {
	ElementReference imgsheet;

	//protected WebGLContext webGL;
	protected Canvas2DContext canvas;
	protected BECanvasComponent canvasRef;

	protected string imageDataURL;

	protected int glWidth;
	protected int glHeight;

	MemoryStream Draw(ImageFormat format)
	{
		Bitmap bitmap = new Bitmap(800, 600, System.Drawing.Imaging.PixelFormat.Format32bppArgb);
		Graphics graphics = Graphics.FromImage(bitmap);
		graphics.SmoothingMode = SmoothingMode.AntiAlias;

		Brush brush = new LinearGradientBrush(new Point(0, 0), new Point(1000, 800), Color.Red, Color.Blue);
		graphics.FillEllipse(brush, 100, 100, 800, 600);

		MemoryStream result = new MemoryStream();
		bitmap.Save(result, format);
		result.Seek(0, SeekOrigin.Begin);
		return result;
	}

	async Task<string> GenImageAsync()
	{
		byte[] imageBytes = Draw(ImageFormat.Png).ToArray();
		string img = string.Format("data:image/png;base64,{0}", Convert.ToBase64String(imageBytes));
		await JsRuntime.InvokeAsync<object>("console.log", "Img = " + img);
		return img;
	}

	protected override async Task OnAfterRenderAsync(bool firstRender)
	{
		if (firstRender)
		{
			await JsRuntime.InvokeAsync<object>("console.log", "First render!");
			await JsRuntime.InvokeAsync<IJSObjectReference>("import", "./scr.js?v=" + (DateTime.Now.ToString("yyyyMMddHHmmss")));

			imageDataURL = await GenImageAsync();

			glWidth = (int)canvasRef.Width;
			glHeight = (int)canvasRef.Height;
			canvas = await canvasRef.CreateCanvas2DAsync();

			await JsRuntime.InvokeAsync<object>("initGame", DotNetObjectReference.Create(this));
		}

		await JsRuntime.InvokeAsync<object>("console.log", "Render!");
	}

	[JSInvokable]
	public async ValueTask GameLoop(float timeStamp)
	{
		await canvas.BeginBatchAsync();

		await canvas.SetFillStyleAsync("green");
		await canvas.FillRectAsync(0, 0, glWidth, glHeight);

		await canvas.SetFontAsync("24px verdana");
		await canvas.StrokeTextAsync($"time: {timeStamp}", 20, 80);


		await canvas.DrawImageAsync(imgsheet, 50, 50);

		await canvas.EndBatchAsync();
	}
}